# TETRIS

-----

## 程序介绍

本程序windows平台实现了控制台上的*俄罗斯方块*游戏。

**请注意:本程序实测可在gcc (MinGW.org GCC-6.3.0-1) 6.3.0/windows10 64bit环境下正常编译运行，请留意编译器版本。**

-----
## 实现思路

本文在主函数中通过延时函数(为了防止误差，自行实现了一个基于绝对时间的`sleep()`函数)逐帧更新一个计数器(`tick`)，并基于该计数器和输入完成响应和刷新的动作。

### 刷新屏幕

由于在实际操作中发现io操作和`system()`函数较慢，不能适应可能需要逐帧刷新的工作场景，而会导致延迟与闪屏，因此抛弃了使用`system("cls")`清屏的做法。为了进一步优化代码，本程序使用了一个`hash map`来标记需要更新的部分(一个部分通常为主空间的一行)，使用[`SetConsoleCursorPosition()`函数](https://msdn.microsoft.com/zh-cn/library/windows/desktop/ms686025(v=vs.85).aspx)针对性地刷新，并通过优化算法尽量减少了不必要的刷新步骤。由此，不需要刷新的部分不会被清空，起到了`double buffer`的效果，这就带来了视觉上的连续性。

同时，为了增加美观度以及清晰度，本程序通过[`SetConsoleTextAttribute()`函数](https://msdn.microsoft.com/zh-cn/library/windows/desktop/ms686047(v=vs.85).aspx)使用了丰富的颜色来标记方块的不同来源和不同状态(例如，即将消失)。

### 操作响应

对于*俄罗斯方块*来说，需要响应的操作只有时间变化(利用`tick`记录和监听)和一部分键盘事件，这一点体现在了`main()`函数中。

完成对事件的响应的函数为`next()`函数，基本实现思路是:

1. 调用`clear()`函数清理屏幕上的方块。
2. 执行响应。
3. 判断是否碰撞，若碰撞，回滚响应。若有多个事件，回滚最不重要的事件后再次判断。
4. 根据屏幕内容是否发生实质上的改变，调用`prt(1)`或`prt(0)`。

### 高分榜

本程序通过文件io的方式使用`record.dat`文件记录了历史高分榜。

-----
## 特点

- 基本参数以宏的形式给出，便于调整
- 颜色丰富，视觉效果较好
- 有基本的动画效果(在某一行已满，需要清除时)
- 拥有记录历史最高分的功能

-----
## 使用的算法和数据结构

- 基本的碰撞检测算法
- 用于提示需要刷新区域的`hash map`
- 利用控制台实现的`Double Buffer`
- `COORD`结构体
- 储存屏幕内容、方块形状的数组
- 储存方块外形的`bitmap`
- 文件结构体

-----
## 待改进点

- 可移植性(通过`#IFDEF`语句判断编译环境)
- 通过读取配置文件修改窗口位置、大小的功能，使用非硬编码
- 尽量不使用`goto`语句
- 可将通用部分抽象为`engine.h`，便于后续开发
